<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ IP ë° ìœ„ì¹˜ í™•ì¸ - My IP & Location</title>
    
    <link rel="stylesheet" href="css/style.css">
    <script src="js/common.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        .ip-card {
            background: linear-gradient(135deg, #2c3e50, #4ca1af); /* ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ë‹¤í¬ ê·¸ë¼ë°ì´ì…˜ */
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            margin-bottom: 30px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .ip-label { font-size: 14px; opacity: 0.8; margin-bottom: 5px; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; }
        
        .ip-address {
            font-size: 42px;
            font-weight: 800;
            margin: 10px 0;
            font-family: 'Consolas', monospace;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            word-break: break-all;
        }

        .location-text { font-size: 18px; margin-top: 5px; opacity: 0.9; font-weight: 300; }

        /* ì§€ë„ ì˜ì—­ */
        #map {
            height: 400px;
            width: 100%;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #ddd;
            z-index: 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* ì •ë³´ í…Œì´ë¸” */
        .info-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
        }
        .info-table th, .info-table td { padding: 18px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .info-table th { background-color: #f9fafb; width: 30%; color: #555; font-weight: 600; }
        .info-table td { font-family: 'Consolas', monospace; color: #333; }
        .info-table tr:last-child th, .info-table tr:last-child td { border-bottom: none; }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner {
            display: inline-block;
            width: 30px; height: 30px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="tool-box">
            <h2 style="text-align: center; margin-bottom: 20px;">ğŸŒ IP & ìœ„ì¹˜ ì¶”ì </h2>

            <div class="ip-card">
                <div class="ip-label">Your Public IP Address</div>
                <div class="ip-address" id="ipDisplay">
                    <div class="spinner"></div> </div>
                <div class="location-text" id="locDisplay">Scanning Network...</div>
            </div>

            <div id="map"></div>

            <h3 style="margin-left: 5px; color: #34495e;">ğŸ“¡ ìƒì„¸ ë„¤íŠ¸ì›Œí¬ ì •ë³´</h3>
            <table class="info-table">
                <tr><th>ISP (í†µì‹ ì‚¬)</th><td id="ispDisplay">-</td></tr>
                <tr><th>Client Info</th><td id="uaDisplay">-</td></tr>
                <tr><th>Coordinates</th><td id="coordDisplay">-</td></tr>
                <tr><th>Timezone</th><td id="tzDisplay">-</td></tr>
            </table>
        </div>

        <div style="margin-top: 40px; line-height: 1.6; color: #444; font-size: 14px;">
            <h3>â„¹ï¸ ê°œë°œì ë…¸íŠ¸</h3>
            <p>
                í˜„ì¬ ì´ ê¸°ëŠ¥ì€ ì™¸ë¶€ GeoIP APIë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤. 
                ì¶”í›„ ìì²´ êµ¬ì¶•ëœ <strong>C# High-Performance Backend</strong> ì„œë²„ë¡œ ì „í™˜ë  ì˜ˆì •ì…ë‹ˆë‹¤. 
                (ìœ„ì¹˜ ì •ë³´ëŠ” í†µì‹ ì‚¬ ì„œë²„ ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œë˜ë¯€ë¡œ ì‹¤ì œ ì£¼ì†Œì™€ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)
            </p>
        </div>
    </div>

    <script>
        // ==========================================================
        // [ì„¤ì •] ë°±ì—”ë“œ êµì²´ ì‹œ ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ë©´ ë©ë‹ˆë‹¤.
        // ==========================================================
        const USE_MY_BACKEND = false; // trueë¡œ ë°”ê¾¸ë©´ ë‚´ ì„œë²„ ì‚¬ìš©
        const MY_BACKEND_URL = "http://localhost:5000/api/myip"; 
        
        // ì™¸ë¶€ ë¬´ë£Œ API (ipapi.co: ë³„ë„ í‚¤ ì—†ì´ ì‚¬ìš© ê°€ëŠ¥, JSON ë¦¬í„´)
        const EXTERNAL_API_URL = "https://ipapi.co/json/"; 

        // ==========================================================

        async function initMyIp() {
            const ipDisplay = document.getElementById('ipDisplay');
            const locDisplay = document.getElementById('locDisplay');

            try {
                let data;

                if (USE_MY_BACKEND) {
                    // [PLAN B] ë‚˜ì¤‘ì— C# ì„œë²„ ì™„ì„± í›„ ì‹¤í–‰ë  ì½”ë“œ
                    // ì„œë²„ ì‘ë‹µ ì˜ˆì‹œ: { ip: "1.1.1.1", city: "Seoul", lat: 37.5, lon: 127.0, org: "KT" }
                    const response = await fetch(MY_BACKEND_URL);
                    data = await response.json();
                } else {
                    // [PLAN A] í˜„ì¬: ì™¸ë¶€ API ì‚¬ìš©
                    const response = await fetch(EXTERNAL_API_URL);
                    if (!response.ok) throw new Error("API Rate Limit or Blocked");
                    data = await response.json();
                }

                // 1. UI ë°ì´í„° ë°”ì¸ë”©
                ipDisplay.innerText = data.ip;
                locDisplay.innerText = `${data.city}, ${data.region}, ${data.country_name}`;
                document.getElementById('ispDisplay').innerText = data.org || data.asn; // í†µì‹ ì‚¬
                document.getElementById('coordDisplay').innerText = `${data.latitude}, ${data.longitude}`;
                document.getElementById('tzDisplay').innerText = data.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;

                // 2. ì§€ë„ ê·¸ë¦¬ê¸°
                renderMap(data.latitude, data.longitude, data.city);

            } catch (error) {
                console.error(error);
                ipDisplay.innerText = "ì¡°íšŒ ì‹¤íŒ¨";
                locDisplay.innerHTML = "<span style='color:#ffcccb; font-size:14px;'>ê´‘ê³  ì°¨ë‹¨ ê¸°ëŠ¥ì„ ë„ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</span>";
                
                // ì—ëŸ¬ ì‹œ ê¸°ë³¸ ì„œìš¸ ì¢Œí‘œë¡œ ì§€ë„ë¼ë„ ë³´ì—¬ì¤Œ
                renderMap(37.5665, 126.9780, "Default Location");
            }
        }

        // ì§€ë„ ë Œë”ë§ (Leaflet.js)
        function renderMap(lat, lng, label) {
            // ì§€ë„ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ê·¸ë¦¼ (ìƒˆë¡œê³ ì¹¨ ë“± ê³ ë ¤)
            if (window.myLeafletMap) {
                window.myLeafletMap.remove();
            }

            const map = L.map('map').setView([lat, lng], 13);
            window.myLeafletMap = map; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥

            // OpenStreetMap íƒ€ì¼ ë ˆì´ì–´
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            }).addTo(map);

            // ë§ˆì»¤ ë° íŒì—…
            L.marker([lat, lng]).addTo(map)
                .bindPopup(`<b>${label}</b><br>Network Location`)
                .openPopup();
        }

        // í´ë¼ì´ì–¸íŠ¸ ì •ë³´ ë¶„ì„ (User Agent) - í”„ë¡ íŠ¸ì—”ë“œ ì „ìš© ë¡œì§
        function analyzeClientInfo() {
            const ua = navigator.userAgent;
            let os = "Unknown OS";
            
            if (ua.indexOf("Win") !== -1) os = "Windows";
            else if (ua.indexOf("Mac") !== -1) os = "macOS";
            else if (ua.indexOf("Linux") !== -1) os = "Linux";
            else if (ua.indexOf("Android") !== -1) os = "Android";
            else if (ua.indexOf("iPhone") !== -1) os = "iOS";

            let browser = "Unknown Browser";
            if (ua.indexOf("Chrome") !== -1) browser = "Chrome";
            if (ua.indexOf("Safari") !== -1 && ua.indexOf("Chrome") === -1) browser = "Safari";
            if (ua.indexOf("Firefox") !== -1) browser = "Firefox";

            document.getElementById('uaDisplay').innerText = `${os} / ${browser}`;
        }

        // ì‹¤í–‰
        initMyIp();
        analyzeClientInfo();

    </script>
</body>
</html>